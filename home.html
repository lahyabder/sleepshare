<script type="module">
  // 1) استيراد auth من ملف firebase.js (يجب أن يكون في نفس المجلد)
  import { auth } from "./firebase.js";

  // 2) استيراد أدوات Firebase Auth – الإصدار 11.0.1
  import {
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    sendPasswordResetEmail,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  // 3) عناصر الواجهة
  const form = document.getElementById("auth-form");
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const loginBtn = document.getElementById("login-btn");
  const signupBtn = document.getElementById("signup-btn");
  const resetLink = document.getElementById("reset-link");
  const messageBox = document.getElementById("auth-message");

  function showMessage(text, type = "normal") {
    messageBox.textContent = text;
    messageBox.classList.remove("error", "success");
    if (type === "error") messageBox.classList.add("error");
    if (type === "success") messageBox.classList.add("success");
  }

  function mapFirebaseError(code) {
    switch (code) {
      case "auth/invalid-email":
        return "صيغة البريد الإلكتروني غير صحيحة.";
      case "auth/user-not-found":
        return "لا يوجد حساب بهذا البريد. جرّب إنشاء حساب جديد.";
      case "auth/wrong-password":
        return "كلمة المرور غير صحيحة، حاول مرة أخرى.";
      case "auth/email-already-in-use":
        return "يوجد حساب مسجّل بهذا البريد بالفعل.";
      case "auth/weak-password":
        return "كلمة المرور ضعيفة. يجب أن تكون ٦ أحرف فأكثر.";
      default:
        return "حدث خلل بسيط في الاتصال. حاول مرة أخرى لاحقًا.";
    }
  }

  // 4) تسجيل الدخول
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = emailInput.value.trim();
    const password = passwordInput.value;

    if (!email || !password) {
      showMessage("من فضلك أدخل البريد وكلمة المرور.", "error");
      return;
    }

    showMessage("جاري تسجيل الدخول بهدوء...", "normal");
    loginBtn.disabled = true;
    signupBtn.disabled = true;

    try {
      await signInWithEmailAndPassword(auth, email, password);
      showMessage("تم تسجيل الدخول. جاري نقلك...", "success");

      setTimeout(() => {
        window.location.href = "avatar.html";
      }, 1200);
    } catch (err) {
      console.error("Login error:", err);
      showMessage(mapFirebaseError(err.code), "error");
    } finally {
      loginBtn.disabled = false;
      signupBtn.disabled = false;
    }
  });

  // 5) إنشاء حساب جديد
  signupBtn.addEventListener("click", async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;

    if (!email || !password) {
      showMessage("لإنشاء حساب جديد، أدخل بريدًا وكلمة مرور أولًا.", "error");
      return;
    }

    showMessage("جاري إنشاء حسابك الهادئ...", "normal");
    loginBtn.disabled = true;
    signupBtn.disabled = true;

    try {
      await createUserWithEmailAndPassword(auth, email, password);
      showMessage("تم إنشاء الحساب. أهلاً بك في SleepShare.", "success");

      setTimeout(() => {
        window.location.href = "avatar.html";
      }, 1200);
    } catch (err) {
      console.error("Signup error:", err);
      showMessage(mapFirebaseError(err.code), "error");
    } finally {
      loginBtn.disabled = false;
      signupBtn.disabled = false;
    }
  });

  // 6) استرجاع كلمة المرور
  resetLink.addEventListener("click", async () => {
    const email = emailInput.value.trim();

    if (!email) {
      showMessage("أدخل بريدك الإلكتروني أولًا لاسترجاع كلمة المرور.", "error");
      return;
    }

    try {
      await sendPasswordResetEmail(auth, email);
      showMessage("تم إرسال رابط استرجاع كلمة المرور إلى بريدك.", "success");
    } catch (err) {
      console.error("Reset error:", err);
      showMessage(mapFirebaseError(err.code), "error");
    }
  });

  // 7) إذا كان المستخدم مسجّل الدخول بالفعل → تحويل مباشر
  onAuthStateChanged(auth, (user) => {
    if (user) {
      window.location.href = "avatar.html"; // يمكنك تغييره إلى index.html
    }
  });
</script>
