// avatar.js
import {
  onAuthStateChanged,
  signOut,
  updateProfile,
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

import { auth } from "./firebase.js";

// Ø¹Ù†Ø§ØµØ± DOM
const avatarItems = document.querySelectorAll(".avatar-item");
const messageEl = document.getElementById("avatar-message");
const saveBtn = document.getElementById("save-avatar");
const logoutBtn = document.getElementById("avatar-logout");

let currentUser = null;
let selectedAvatar = null;

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
function showMessage(text, type = "success") {
  if (!messageEl) return;
  messageEl.textContent = text || "";
  messageEl.classList.remove("error", "success");
  if (text) {
    messageEl.classList.add(type);
  }
}

// ØªÙØ¹ÙŠÙ„/Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
function setActiveAvatarItem(targetEl) {
  avatarItems.forEach((item) => {
    if (item === targetEl) {
      item.classList.add("active");
    } else {
      item.classList.remove("active");
    }
  });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢ÙØ§ØªØ§Ø± Ù…Ù† localStorage (Ø¥Ù† ÙˆØ¬Ø¯)
function loadStoredAvatar(user) {
  if (!user) return;

  const key = `sleepshare-avatar-${user.uid}`;
  const stored = localStorage.getItem(key);

  if (stored) {
    selectedAvatar = stored;

    avatarItems.forEach((item) => {
      if (item.dataset.avatar === stored) {
        item.classList.add("active");
      } else {
        item.classList.remove("active");
      }
    });

    showMessage("ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢ÙØ§ØªØ§Ø±Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ ðŸŒ™", "success");
  }
}

// Ø­ÙØ¸ Ø§Ù„Ø¢ÙØ§ØªØ§Ø± ÙÙŠ localStorage
function storeAvatar(user, avatarValue) {
  if (!user) return;
  const key = `sleepshare-avatar-${user.uid}`;
  localStorage.setItem(key, avatarValue);
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, (user) => {
  if (!user) {
    // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù†Ø¹ÙŠØ¯Ù‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
    window.location.href = "auth.html";
    return;
  }

  currentUser = user;
  loadStoredAvatar(user);
});

// Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¢ÙØ§ØªØ§Ø±
avatarItems.forEach((item) => {
  item.addEventListener("click", () => {
    const avatarValue = item.dataset.avatar;
    selectedAvatar = avatarValue;
    setActiveAvatarItem(item);
    showMessage(`Ø§Ø®ØªØ±Øª: ${avatarValue}`, "success");
  });
});

// Ø­ÙØ¸ Ø§Ù„Ø¢ÙØ§ØªØ§Ø±
if (saveBtn) {
  saveBtn.addEventListener("click", async () => {
    if (!currentUser) {
      showMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.", "error");
      return;
    }

    if (!selectedAvatar) {
      showMessage("Ø§Ø®ØªØ± Ø¢ÙØ§ØªØ§Ø±Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.", "error");
      return;
    }

    try {
      // Ø­ÙØ¸ ÙÙŠ localStorage
      storeAvatar(currentUser, selectedAvatar);

      // Ø®ÙŠØ§Ø± Ø¨Ø³ÙŠØ·: Ø¯Ù…Ø¬ Ø§Ù„Ø¢ÙØ§ØªØ§Ø± Ù…Ø¹ displayName (Ø¨Ø¯ÙˆÙ† ØªØ¹Ù‚ÙŠØ¯ Firestore Ø§Ù„Ø¢Ù†)
      const currentName = currentUser.displayName || "";
      const emojiPart = selectedAvatar.split(" ")[0]; // Ø£ÙˆÙ„ Ø¬Ø²Ø¡ (Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ)
      const namePart = currentName || "Sleeper";

      await updateProfile(currentUser, {
        displayName: `${emojiPart} ${namePart}`,
      });

      showMessage("ØªÙ… Ø­ÙØ¸ Ø¢ÙØ§ØªØ§Ø±Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ù†ÙˆÙ…Ù‹Ø§ Ù‡Ø§Ø¯Ø¦Ù‹Ø§ ðŸŒŒ", "success");

      // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­ÙˆÙŠÙ„Ù‡ Ù„ØµÙØ­Ø© ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù†ÙˆÙ… Ø§Ù„ÙØ¹Ù„ÙŠØ©
      // Ù…Ø«Ø§Ù„:
      // window.location.href = "sleep.html";
    } catch (err) {
      console.error(err);
      showMessage("ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø¢ÙØ§ØªØ§Ø±ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "error");
    }
  });
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
if (logoutBtn) {
  logoutBtn.addEventListener("click", async () => {
    try {
      await signOut(auth);
      window.location.href = "auth.html";
    } catch (err) {
      console.error(err);
      showMessage("ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "error");
    }
  });
}
